<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="./assets/hangmanicon.ico" type="image/icon">
    <title id="title">HangMan</title>


    <script src="https://kit.fontawesome.com/69266619cf.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="./index.css">
    
 
</head>
<body class="bg-[#1d1d1d]">

    <div class=" w-fit h-fit absolute top-12 left-16 text-gray-200 font-light text-4xl flex justify-between items-center invisible lg:visible">
        <img src="./assets/hangmanicon.png" class="w-14 mr-2 mt-3" alt="app-icon">
        HangMan
        
    </div>
    
    <div id="main-container" class="w-[80%] md:w-fit h-fit  m-auto flex flex-col justify-between mt-16">
        
        <!-- <input type="text" id="letter-input" maxlength="1"> -->

        <div id="text-font" class="h-fit w-full text-white flex justify-between text-md ">

            <div class="flex justify-between flex-col">
                <nav class="mb-2">Errors: <span id="amount-of-errors">0</span></nav>
                <nav class="mb-2">Defeats: <span id="amount-of-defeats">0</span></nav>
                <nav class="mb-2">Wins: <span id="amount-of-wins">0</span></nav>
            </div>
            
            <div class="flex justify-end relative font-sans text-sm h-fit ">  
                <i id="info-icon" class="fa-solid fa-circle-info"></i>
                <div id="info-icon-banner" class="absolute top-0 right-5 w-56 h-fit px-3 py-2 text-left text-xs text-gray-600 bg-gray-100 invisible">
                    Spaces are represented by hyphen.
                    <li>url/words? to see all words in the game or </li>
                    <li>url/words?category=animais to see a specific category </li>
                    
                </div>
            </div>
        
        </div>

        <div class="h-[220px] w-full  relative ">

            <!-- Rope -->
            <!-- <div class="absolute right-36 left-0 top-8 m-auto h-[180px] w-2  rounded-sm bg-red-400"></div>
            <div class="absolute right-10 left-0 top-8 m-auto h-2 w-[120px] rounded-md bg-white"></div> -->

            <div class="absolute right-10 left-0 top-8 m-auto h-[180px] border-t-8 border-l-8 border-white w-[120px] rounded-sm "></div>


            <div id="rope1" class="z-20 absolute right-0 left-0 top-16 m-auto h-[32px] w-[16px] border-2 border-orange-800 rounded-b-full rounded-t-full"></div>
            <div id="rope2" class="z-20 absolute right-0 left-0 top-8 m-auto h-10 w-[2px] bg-orange-800"></div>

            <div id="help-message-container" class="bg-gray-100 z-40 absolute top-5 right-0 left-28 m-auto rounded-t-full rounded-br-full w-fit h-fit py-3 px-2 text-gray-600 font-extrabold font-mono invisible opacity-0 duration-1000">
                HELP!
            </div>

            <!-- Stickman -->
            <div id="stick-head" class="z-30 absolute top-0 bottom-24 left-3 right-0 m-auto rounded-full w-8 h-8 rotate-[35deg] bg-white"></div>

            <div id="stick-body" class="z-10 absolute top-0 bottom-7 left-0 right-0 m-auto rounded-md w-2 h-20 bg-white"></div>
            
            <div id="stick-left-arm" class="z-10 absolute bottom-4 top-0 rotate-[12deg] left-0 right-3 m-auto rounded-md w-2 h-14 bg-white"></div>
            
            <div id="stick-right-arm" class="z-10 absolute bottom-9 top-0 rotate-[-12deg] left-4 right-0 m-auto rounded-md w-2 h-14 bg-white"></div>

            <div id="stick-left-leg" class="absolute bottom-0 top-28 rotate-[5deg] left-0 right-2 m-auto rounded-md w-2 h-24 bg-white"></div>
            <div id="stick-right-leg" class="absolute bottom-0 top-28 rotate-[-10deg] left-3 right-0 m-auto rounded-md w-2 h-20 bg-white"></div>

        </div>


        <div id="absolute-letters-container" >

            <div id="letters-container">
                
            </div>
            
        </div>


        <div id="letters-to-choose-container" class="w-[100%]">


        </div>

        <div class="w-full h-[10%] m-auto  flex justify-center">
            <button id="return-btn" class="border-2 border-white font-bold text-white px-2 text-sm">Return</button>

        </div>


        <div id="defeat-div-banner" class="z-50 absolute top-0 bottom-24 left-0 right-0 m-auto opacity-0 ease-out duration-1000
        w-[40vh] h-[15vh] border-[3vh] text-[1.4em] border-red-700 text-red-600 font-bold flex justify-center items-center invisible">
         G A M E O V E R 
        </div>

     

    </div>
  



    <script defer type="module" >
       
       
        const validOnes = ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];
        let words;
        const category = window.location.search.substring(10)
        let word; 
        let guessedLetters = []
        let errors = 0;
        let defeats = 0
        let wins = 0
        let arrayCont = 0;
        let lettersToChooseContainer = document.getElementById("letters-to-choose-container")


        //add info icon stuff
        document.getElementById("info-icon").addEventListener("mouseover", ()=> {
            document.getElementById("info-icon-banner").style.visibility = "visible"
        })
        document.getElementById("info-icon").addEventListener("mouseleave", ()=> {
            document.getElementById("info-icon-banner").style.visibility = "hidden"
        })

        //help stick msg
        


        window.onload = async () => {
            document.getElementById("title").innerText = `HangMan - ${category}`

            async function fetchData(){
                // const res = await fetch(`http://localhost:3001/words?category=${category}`)
                const res = await fetch("https://hangman-eosin.vercel.app" + `?category=${category}`)
                const data = await res.json()
                words = data

                shuffleArray(words)
                console.log(words)
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }
           

                word = words[arrayCont]
            }
           
            await fetchData();

       

            document.getElementById("return-btn").addEventListener("click", ()=> window.location.href = "/main.html")
            window.addEventListener("keydown", (e)=> {
                if (e.altKey || e.ctrlKey || e.shiftKey) return
                regraDeNegocio(e, "keyEvent")
            })

           
        
            
            validOnes.map(letter => {

            let newDiv = document.createElement("button")
            newDiv.className="w-3 h-3 p-3 md:w-6 md:h-6 md:p-4 m-[1px] text-white font-bold cursor-pointer border-2 border-white flex items-center justify-center"
            newDiv.setAttribute("value", letter)

            newDiv.addEventListener("click", (e) => regraDeNegocio(e, "mouseEvent"))
            newDiv.innerText = letter
            lettersToChooseContainer.append(newDiv)
        })
        

        displayPalavra(word);
        }
        

        
        function regraDeNegocio(e, eventtype) {
            let chosenLetter;
            if (eventtype === "mouseEvent") chosenLetter = e.target.getAttribute("value").toUpperCase()
            if (eventtype === "keyEvent") chosenLetter = e.key.toUpperCase();
          


            if (!validateField(chosenLetter)) {alert("Invalid Field.")} else {
            const res2 = checkIfLetterHasGone(chosenLetter)

            if (res2) alert("Letra ja foi escolhida")
            else {

                guessedLetters.push(chosenLetter)
                const res = checkIfContains(chosenLetter);
                if (res.contain) {
                    addValuesToDomDivs(res.indexOfTheRights, chosenLetter)
                    checkVictory()
                } else {
                    
                    errors++;
                    updateStick()
                    document.getElementById("amount-of-errors").innerText = errors
                    checkGameOver();
                }

                if (eventtype === "mouseEvent") {
                    
                    changeLetterToChoseState(e.target);
                } else { 
                    Array.from(lettersToChooseContainer.children).map(childDiv => {
                        if (childDiv.getAttribute("value").toUpperCase() === chosenLetter){
                            changeLetterToChoseState(childDiv)
                        } 
                    })

                }


            }

            }
        }

        function changeLetterToChoseState(DOMelement) {
            DOMelement.style.backgroundColor = "rgb(50,50,50)"
            DOMelement.style.color = "rgb(120,120,120)"
            DOMelement.style.border = "2px solid rgb(200,200,200)"
            DOMelement.style.cursor = "unset"
            DOMelement.setAttribute("disabled", "true")
        }


      
       function updateStick() {
        switch(errors){
            case 0:
                document.getElementById("stick-head").style.visibility = "hidden"
                document.getElementById("stick-body").style.visibility = "hidden"
                document.getElementById("stick-left-arm").style.visibility = "hidden"
                document.getElementById("stick-right-arm").style.visibility = "hidden"
                document.getElementById("stick-left-leg").style.visibility = "hidden"
                document.getElementById("stick-right-leg").style.visibility = "hidden"
                document.getElementById("rope1").style.visibility = "hidden"
                document.getElementById("rope1").style.height = "32px"
                document.getElementById("rope2").style.visibility = "hidden"
                document.getElementById("help-message-container").style.visibility = "hidden"
                document.getElementById("help-message-container").style.opacity = "0%"
                break;
            case 1:
                document.getElementById("stick-head").style.visibility = "visible"
                document.getElementById("rope1").style.visibility = "visible"
                document.getElementById("rope2").style.visibility = "visible"
                break;
            case 2:
                document.getElementById("stick-body").style.visibility = "visible"
                document.getElementById("rope1").style.width = "17px"
                document.getElementById("rope1").style.height = "32px"
                break;
            case 3:
                document.getElementById("stick-left-arm").style.visibility = "visible"
                document.getElementById("rope1").style.height = "28px"
                break;
            case 4:
                document.getElementById("stick-right-arm").style.visibility = "visible"
                document.getElementById("rope1").style.height = "22px"
                break;
            case 5:
                    document.getElementById("stick-left-leg").style.visibility = "visible"
                    document.getElementById("rope1").style.height = "18px"
                    document.getElementById("help-message-container").style.visibility = "visible"
                    document.getElementById("help-message-container").style.opacity = "100%"
                    break;
            case 6:
                    document.getElementById("stick-right-leg").style.visibility = "visible"
                    document.getElementById("rope1").style.height = "15px"
                    break;
           
        }
       }
        


        function validateField(chosenletter) {
            if (chosenletter.trim() === "") return false;
            if (chosenletter.length > 1) return false;
            
            const validation = validOnes.find(letter => letter === chosenletter)
            if (!validation) return false;
            return true
        }
 

        function displayPalavra(word) {
            const absoluteLettersContainer = document.getElementById("absolute-letters-container")
            const lettersContainer = document.getElementById("letters-container")
            Array.from(word).map(letter => {
                let newDiv = document.createElement("div");
                console.log(letter)
                if(letter == "-"){
                    newDiv.innerText = "-"
                }

                newDiv.className = "letter-div"
                lettersContainer.append(newDiv)
                
            })
            absoluteLettersContainer.append(lettersContainer)
        }

        function checkIfContains(chosenletter) {
            const indexOfTheRights = [];
            let cont = 0;
            Array.from(word).map(letter => {
                
                if (letter === chosenletter) {
                    indexOfTheRights.push(cont)
                }
                cont++;

            })
            if (indexOfTheRights.length > 0) {
                return {contain: true, indexOfTheRights}
            }
            return {contain: false};
        }

        function addValuesToDomDivs(indexes, letter) {
            indexes.map(index => {
                document.getElementById("letters-container").children[index].innerHTML = letter 
            })
        }

        function checkIfLetterHasGone(chosenLetter) {
            const a = guessedLetters.find(letter => letter === chosenLetter)
            if (a) return true;
            return false
        }
        
        
        function checkGameOver() {
            if (errors > 6) {
                setTimeout(()=> {
                 
                    //game over here
                    callBannerDivAnimation("defeat")

                    defeats ++;
                    document.getElementById("amount-of-defeats").innerText = defeats 
                    rebuildGame();
                }, 75)
            
            }
        }

        function callBannerDivAnimation(gameResult){
            let defeatDivBanner = document.getElementById("defeat-div-banner")
            if (gameResult === "defeat") { 
                defeatDivBanner.style.border = "3vh solid red"
                defeatDivBanner.style.color = "red"
                defeatDivBanner.innerText = "G A M E O V E R"
            }
            if (gameResult === "win") { 
                defeatDivBanner.style.border = "3vh solid green" 
                defeatDivBanner.style.color = "green"
                defeatDivBanner.innerText = "V I C T O R Y"
            }
            
            defeatDivBanner.style.visibility = "visible"
            defeatDivBanner.style.opacity = "30%"
            defeatDivBanner.style.fontSize = "1.5em"
            defeatDivBanner.style.width = "85vh"
            defeatDivBanner.style.height = "25vh"
            
            setTimeout(() => {
                defeatDivBanner.style.opacity = "0%"
            }, 350);

            setTimeout(() => {
                defeatDivBanner.style.width = "40vh"
                defeatDivBanner.style.height = "15vh" 
            }, 1000);
        }
        

        function checkVictory () {
            let EmptyFound = Array.from(document.getElementById("letters-container").children).find( div => div.innerText == "" )
            if (!EmptyFound) {
                setTimeout(()=> {
                    callBannerDivAnimation("win")
                    wins ++;
                    document.getElementById("amount-of-wins").innerText = wins 
                    rebuildGame();
                }, 75)
            } else return
        }


        function rebuildGame() {
            while (document.getElementById("letters-container").hasChildNodes()){
                    document.getElementById("letters-container").lastChild.remove();
                }
                arrayCont++
                word = words[arrayCont]
                guessedLetters = []
                displayPalavra(word)
                Array.from(document.getElementById("letters-to-choose-container").children).map(letterDiv => {
                    letterDiv.style.backgroundColor = "rgba(0,0,0,0)"
                    letterDiv.style.color = "white"
                    letterDiv.style.border = "2px solid white"
                    letterDiv.style.cursor = "pointer"
                    letterDiv.removeAttribute("disabled")
                })


                errors = 0;
                document.getElementById("amount-of-errors").innerText = errors
                updateStick()
                
                
        }

    </script>
</body>
</html>